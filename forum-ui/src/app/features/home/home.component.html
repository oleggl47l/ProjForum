<div class="home-container">
  <!-- Хедер -->
  <div class="page-header">
    <div class="header-content">
      <h1 tuiTitle size="l">
        <tui-icon icon="tuiIconMessageSquare" aria-hidden="true"></tui-icon>
        Форум сообщества
      </h1>
      <p class="header-subtitle">Обсуждайте, делитесь, вдохновляйтесь</p>
    </div>

    <button
      tuiButton
      size="m"
      appearance="primary"
      (click)="openCreatePostDialog()"
      (keydown.enter)="openCreatePostDialog()"
      (keydown.space)="openCreatePostDialog()"
      class="create-post-btn"
      aria-label="Создать новый пост"
      type="button"
    >
      <tui-icon icon="tuiIconPlus" class="mr-2" aria-hidden="true"></tui-icon>
      Создать пост
    </button>
  </div>

  <!-- Поиск -->
  <div class="search-section">
    <tui-textfield
      [(ngModel)]="searchQuery"
      (ngModelChange)="applyFilters()"
      [tuiTextfieldCleaner]="true"
      class="search-field"
      aria-label="Поиск постов"
    >
      <tui-icon icon="tuiIconSearch" slot="left" aria-hidden="true"></tui-icon>
      <input
        tuiTextfield
        type="search"
        placeholder="Поиск постов..."
        aria-describedby="search-description"
      />
    </tui-textfield>
    <div id="search-description" class="sr-only">
      Ищите по заголовку, содержанию или категории постов
    </div>
  </div>

  <!-- Теги для фильтрации -->
  @if (tags.length > 0) {
    <div class="tags-filter-section">
      <h3 tuiTitle size="s" class="tags-title">
        <tui-icon icon="tuiIconTag" size="s" aria-hidden="true"></tui-icon>
        Фильтр по тегам
      </h3>
      <div class="tags-cloud" role="group" aria-labelledby="tags-title">
        @for (tag of tags; track tag.id) {
          <button
            tuiBadge
            [appearance]="selectedTags.includes(tag.name || '') ? 'primary' : 'secondary'"
            (click)="toggleTagFilter(tag.name || '')"
            (keydown.enter)="toggleTagFilter(tag.name || '')"
            (keydown.space)="toggleTagFilter(tag.name || '')"
            class="tag-filter-btn"
            [attr.aria-pressed]="selectedTags.includes(tag.name || '')"
            [attr.aria-label]="'Фильтр по тегу ' + (tag.name || '') + (selectedTags.includes(tag.name || '') ? ', выбран' : '')"
            type="button"
            role="checkbox"
          >
            {{ tag.name }}
          </button>
        }
      </div>
    </div>
  }

  <!-- Основной контент -->
  <main class="main-content" aria-label="Основной контент форума">
    <!-- Список постов -->
    <div class="posts-section">
      <div class="section-header">
        <h2 tuiTitle size="m">Посты сообщества</h2>
        <div class="posts-count" aria-live="polite" aria-atomic="true">
          Показано {{ filteredPosts.length }} из {{ posts.length }}
        </div>
      </div>

      @if (isLoading) {
        <div class="loading-state" aria-live="polite" aria-busy="true">
          <tui-loader size="l" aria-label="Загрузка постов"></tui-loader>
          <p>Загрузка постов...</p>
        </div>
      } @else if (posts.length === 0) {
        <div class="empty-state" role="alert">
          <tui-icon icon="tuiIconFileText" size="xl" aria-hidden="true"></tui-icon>
          <h3 tuiTitle size="s">Постов не найдено</h3>
          <p>Попробуйте изменить параметры фильтрации</p>
          <button
            tuiButton
            size="m"
            appearance="outline"
            (click)="clearFilters()"
            (keydown.enter)="clearFilters()"
            (keydown.space)="clearFilters()"
            type="button"
            aria-label="Сбросить все фильтры"
          >
            Сбросить фильтры
          </button>
        </div>
      } @else {
        <!-- Список постов -->
        <div class="posts-list" role="list" aria-label="Список постов">
          @for (post of filteredPosts; track post.id; let i = $index) {
            <article
              class="post-card-wrapper"
              role="listitem"
              [attr.aria-posinset]="i + 1"
              [attr.aria-setsize]="filteredPosts.length"
            >
              <a
                [routerLink]="['/post', post.id]"
                class="post-link"
                [attr.aria-label]="'Пост: ' + (post.title || '') + (post.category ? ', категория: ' + post.category : '')"
              >
                <div class="post-card" [class.draft]="!post.isPublished">
                  <!-- Заголовок поста -->
                  <div class="post-header">
                    <div class="post-meta">
                      <div class="author-info">
                        <tui-avatar size="s" aria-hidden="true">
                          {{ post.authorId?.substring(0, 2) || 'AU' }}
                        </tui-avatar>
                        <div class="author-details">
                          <span class="author-id">Пользователь {{ post.authorId?.substring(0, 8) }}</span>
                          <span class="post-date">
                            <tui-icon icon="tuiIconClock" size="s" aria-hidden="true"></tui-icon>
                            {{ formatDate(post.createdAt) }}
                          </span>
                        </div>
                      </div>
                    </div>

                    @if (post.category) {
                      <div
                        class="category-badge"
                        [style.background]="getCategoryColor(post.category)"
                        aria-label="Категория: {{ post.category }}"
                      >
                        {{ post.category }}
                      </div>
                    }
                  </div>

                  <!-- Контент поста -->
                  <div class="post-body">
                    <h3 tuiTitle size="m" class="post-title">
                      {{ post.title }}
                      @if (!post.isPublished) {
                        <tui-badge
                          appearance="warning"
                          size="s"
                          class="draft-badge"
                          aria-label="Черновик"
                        >
                          Черновик
                        </tui-badge>
                      }
                    </h3>

                    <p class="post-excerpt">
                      {{ getPostExcerpt(post.content || '') }}
                    </p>

                    @if (post.tagNames && post.tagNames.length > 0) {
                      <div class="post-tags" role="group" aria-label="Теги поста">
                        @for (tag of post.tagNames; track tag) {
                          <span class="post-tag">
                            <tui-icon icon="tuiIconTag" size="s" aria-hidden="true"></tui-icon>
                            {{ tag }}
                          </span>
                        }
                      </div>
                    }
                  </div>

                  <!-- Футер поста -->
                  <div class="post-footer">
                    <div class="post-stats">
                      <span
                        tuiHint="Просмотры"
                        tuiHintDirection="top"
                        class="stat"
                        tabindex="0"
                        role="tooltip"
                      >
                        <tui-icon icon="tuiIconEye" size="s" aria-hidden="true"></tui-icon>
                        0
                      </span>
                      <span
                        tuiHint="Комментарии"
                        tuiHintDirection="top"
                        class="stat"
                        tabindex="0"
                        role="tooltip"
                      >
                        <tui-icon icon="tuiIconMessageSquare" size="s" aria-hidden="true"></tui-icon>
                        0
                      </span>
                    </div>
                  </div>
                </div>
              </a>
            </article>
          }
        </div>

        <!-- Пагинация -->
        @if (totalPages > 1) {
          <div class="pagination-wrapper" aria-label="Навигация по страницам">
            <tui-pagination
              [length]="totalPages"
              [(index)]="currentPage"
              class="pagination"
              aria-label="Пагинация"
            ></tui-pagination>
          </div>
        }
      }
    </div>
  </main>

  <!-- Временное сообщение вместо диалога -->
  @if (isCreatingPost) {
    <div
      class="dialog-overlay"
      role="dialog"
      aria-labelledby="dialog-title"
      aria-modal="true"
    >
      <div class="dialog">
        <h3 id="dialog-title">Создание поста</h3>
        <p>Функция создания поста будет доступна позже</p>
        <button
          tuiButton
          (click)="onPostCreated()"
          (keydown.enter)="onPostCreated()"
          (keydown.space)="onPostCreated()"
          type="button"
          aria-label="Закрыть диалог создания поста"
        >
          Закрыть
        </button>
      </div>
    </div>
  }
</div>
