@if (open) {
  <div
    class="dialog-overlay"
    (click)="closeDialog()"
    (keydown.enter)="closeDialog()"
    (keydown.escape)="closeDialog()"
    tabindex="0"
    role="button"
    aria-label="Закрыть диалог"
  >
    <div
      #dialogContent
      class="dialog-content"
      (click)="$event.stopPropagation()"
      role="dialog"
      aria-labelledby="dialog-title"
      aria-modal="true"
    >
      <h2 id="dialog-title" class="dialog-title">
        <tui-icon icon="tuiIconFilePlus" size="m" class="dialog-icon"></tui-icon>
        Создать новый пост
      </h2>

      <!-- Сообщения об ошибках и успехе -->
      @if (errorMessage) {
        <div class="error-message" role="alert">
          <tui-icon icon="tuiIconAlertCircle" size="s"></tui-icon>
          {{ errorMessage }}
        </div>
      }

      @if (successMessage) {
        <div class="success-message" role="status">
          <tui-icon icon="tuiIconCheckCircle" size="s"></tui-icon>
          {{ successMessage }}
        </div>
      }

      <!-- Лоадер при загрузке данных -->
      @if (isLoading) {
        <div class="loading-indicator" aria-busy="true">
          <tui-loader size="m" aria-label="Загрузка данных..."></tui-loader>
          <p>Загрузка данных...</p>
        </div>
      }

      <form (ngSubmit)="createPost()" class="post-form" #postForm="ngForm" [hidden]="isLoading">
        <!-- Заголовок -->
        <div class="form-field">
          <div class="field-label">
            Заголовок
            <span class="required">*</span>
          </div>
          <tui-textfield>
            <input
              tuiTextfield
              id="title"
              [(ngModel)]="post.title"
              name="title"
              required
              [tuiAutoFocus]="true"
              placeholder="Введите заголовок поста"
              aria-required="true"
              [disabled]="isCreatingPost"
              maxlength="200"
            />
          </tui-textfield>
          <div class="field-hint">Будьте лаконичны, но информативны</div>
        </div>

        <!-- Категория -->
        <div class="form-field">
          <div class="field-label">
            Категория
            <span class="required">*</span>
          </div>

          <div class="category-container">
            <!-- Выбранная категория -->
            <div class="selected-category">
              @if (post.categoryName) {
                <div class="selected-category-item">
                  {{ post.categoryName }}
                  <button
                    type="button"
                    class="remove-category"
                    (click)="clearCategory()"
                    (keydown.enter)="clearCategory()"
                    (keydown.space)="clearCategory()"
                    aria-label="Удалить категорию"
                    [disabled]="isCreatingPost"
                  >
                    ×
                  </button>
                </div>
              }

              <!-- Поле для добавления новой категории -->
              <div class="add-category-input">
                <input
                  type="text"
                  [(ngModel)]="newCategoryInput"
                  name="newCategory"
                  placeholder="Введите категорию и нажмите Enter..."
                  (keydown.enter)="addCustomCategory($event)"
                  [disabled]="isCreatingPost || isCreatingCategory"
                  #categoryInput
                  maxlength="100"
                />
                <button
                  type="button"
                  (click)="addCustomCategory()"
                  (keydown.enter)="addCustomCategory()"
                  (keydown.space)="addCustomCategory()"
                  [disabled]="!newCategoryInput.trim() || isCreatingPost || isCreatingCategory"
                >
                  @if (isCreatingCategory) {
                    <tui-loader size="xs"></tui-loader>
                    Добавление...
                  } @else {
                    Добавить
                  }
                </button>
              </div>
            </div>

            <!-- Доступные категории -->
            @if (categories.length > 0) {
              <div class="field-description">Выберите из доступных категорий или добавьте свою:</div>
              <div class="available-categories" role="group" aria-label="Доступные категории">
                @for (category of categories; track category.id) {
                  <button
                    type="button"
                    class="category-option"
                    [class.selected]="post.categoryName === category.name"
                    (click)="selectCategory(category.name || '')"
                    (keydown.enter)="selectCategory(category.name || '')"
                    (keydown.space)="selectCategory(category.name || '')"
                    [attr.aria-pressed]="post.categoryName === category.name"
                    [disabled]="isCreatingPost"
                  >
                    {{ category.name }}
                    @if (post.categoryName === category.name) {
                      <span class="category-check">✓</span>
                    }
                  </button>
                }
              </div>
            } @else {
              <div class="field-hint warning">Не удалось загрузить категории</div>
            }
          </div>
        </div>

        <!-- Теги -->
        <div class="form-field">
          <div class="field-label">
            Теги (опционально)
          </div>
          <div class="tags-container">
            <!-- Выбранные теги -->
            <div class="selected-tags" role="list" aria-label="Выбранные теги">
              @for (tag of post.tagNames; track tag; let i = $index) {
                <div class="selected-tag" role="listitem">
                  {{ tag }}
                  <button
                    type="button"
                    class="remove-tag"
                    (click)="removeTag(tag)"
                    (keydown.enter)="removeTag(tag)"
                    (keydown.space)="removeTag(tag)"
                    aria-label="Удалить тег {{ tag }}"
                    [disabled]="isCreatingPost"
                  >
                    ×
                  </button>
                </div>
              }
              <!-- Поле для добавления нового тега -->
              <div class="add-tag-input">
                <input
                  type="text"
                  [(ngModel)]="newTagInput"
                  name="newTag"
                  placeholder="Введите тег и нажмите Enter..."
                  (keydown.enter)="addCustomTag($event)"
                  [disabled]="isCreatingPost"
                  #tagInput
                  maxlength="50"
                />
                <button
                  type="button"
                  (click)="addCustomTag()"
                  (keydown.enter)="addCustomTag()"
                  (keydown.space)="addCustomTag()"
                  [disabled]="!newTagInput.trim() || isCreatingPost"
                >
                  Добавить
                </button>
              </div>
            </div>

            <!-- Доступные теги -->
            @if (availableTags.length > 0) {
              <div class="field-description">Выберите из доступных тегов или добавьте свой:</div>
              <div class="available-tags" role="group" aria-label="Доступные теги">
                @for (tag of availableTags; track tag.id) {
                  <button
                    type="button"
                    class="tag-option"
                    [class.selected]="post.tagNames.includes(tag.name || '')"
                    (click)="toggleTag(tag.name || '')"
                    (keydown.enter)="toggleTag(tag.name || '')"
                    (keydown.space)="toggleTag(tag.name || '')"
                    [attr.aria-pressed]="post.tagNames.includes(tag.name || '')"
                    [disabled]="isCreatingPost"
                  >
                    {{ tag.name }}
                    @if (post.tagNames.includes(tag.name || '')) {
                      <span class="tag-check">✓</span>
                    }
                  </button>
                }
              </div>
            }
          </div>
        </div>

        <!-- Содержимое -->
        <div class="form-field">
          <div class="field-label">
            Содержимое
            <span class="required">*</span>
          </div>
          <tui-textfield>
            <input
              tuiTextfield
              id="content"
              [(ngModel)]="post.content"
              name="content"
              required
              [tuiAutoFocus]="true"
              placeholder="Введите описание поста"
              aria-required="true"
              [disabled]="isCreatingPost"
              maxlength="5000"
            />
          </tui-textfield>
          <div class="field-hint">Можно использовать Markdown-разметку</div>
        </div>

        <!-- Кнопки -->
        <div class="dialog-actions">
          <button
            tuiButton
            type="button"
            appearance="flat"
            (click)="closeDialog()"
            (keydown.enter)="closeDialog()"
            (keydown.space)="closeDialog()"
            [disabled]="isCreatingPost"
            aria-label="Отменить создание поста"
          >
            Отмена
          </button>
          <button
            tuiButton
            type="submit"
            appearance="primary"
            [disabled]="!post.title || !post.content || !post.categoryName || isCreatingPost"
            aria-label="Создать новый пост"
          >
            @if (isCreatingPost) {
              <tui-loader size="xs" class="button-loader"></tui-loader>
              Создание...
            } @else {
              Создать пост
            }
          </button>
        </div>
      </form>
    </div>
  </div>
}
