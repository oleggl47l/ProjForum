<div class="home-container">
  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ —Ü–µ–Ω—Ç—Ä—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
  <div class="centered-header">
    <div class="header-content">
      <h1 class="main-title">
        –ü–æ–ª–∏—Ñ–æ—Ä—É–º
      </h1>
      <p class="header-subtitle"></p>
      <p class="header-subtitle">–û–±—Å—É–∂–¥–∞–π—Ç–µ, –¥–µ–ª–∏—Ç–µ—Å—å, –≤–¥–æ—Ö–Ω–æ–≤–ª—è–π—Ç–µ—Å—å</p>
    </div>
  </div>

  <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ -->
  @if (errorMessage()) {
    <div style="
    margin: 1rem auto;
    max-width: 1200px;
    padding: 0 1rem;
  ">
      <div style="
      background: #ff4444;
      color: white;
      padding: 1rem;
      border-radius: 8px;
      font-weight: 500;
    ">
        {{ errorMessage() }}
      </div>
    </div>
  }

  <button
    tuiButton
    size="s"
    (click)="loadInitialData()"
    [disabled]="isLoading()"
    style="margin-left: 1rem; background: transparent; color: transparent"
  >
    @if (isLoading()) {
      –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...
    } @else {
      –û–±–Ω–æ–≤–∏—Ç—å
    }
  </button>

  <!-- –•–µ–¥–µ—Ä —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π -->
  <div class="page-header">
    <div class="header-nav">
      <div class="nav-right">
        <!-- –ë–ª–æ–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
        @if (currentUser()) {
          <div class="user-info-short" style="margin-right: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.8);">
              –ü—Ä–∏–≤–µ—Ç, <strong>{{ currentUser()!.userName }}</strong>
            </div>
          </div>
        }

        @if (!currentUser()) {
          <button
            tuiButton
            routerLink="/login"
            class="auth-btn"
            type="button"
            aria-label="–í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç"
          >
            –í–æ–π—Ç–∏
          </button>
        }

        <button
          tuiButton
          routerLink="/profile"
          class="auth-btn profile-btn"
          type="button"
          aria-label="–ü–µ—Ä–µ–π—Ç–∏ –≤ –ø—Ä–æ—Ñ–∏–ª—å"
        >
          –ü—Ä–æ—Ñ–∏–ª—å
        </button>
      </div>
    </div>
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
  <div class="main-content">
    <!-- –ü–∞–Ω–µ–ª—å –ø–æ–∏—Å–∫–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏—è -->
    <div class="actions-panel">
      <div class="search-container">
        <input
          type="search"
          [ngModel]="searchQuery()"
          (ngModelChange)="searchQuery.set($event); applyFilters()"
          placeholder="–ü–æ–∏—Å–∫ –ø–æ—Å—Ç–æ–≤..."
          class="search-input"
          aria-label="–ü–æ–∏—Å–∫ –ø–æ—Å—Ç–æ–≤"
        />
        @if (searchQuery()) {
          <button
            class="clear-search"
            (click)="clearSearchQuery()"
            (keyup.enter)="clearSearchQuery()"
            aria-label="–û—á–∏—Å—Ç–∏—Ç—å –ø–æ–∏—Å–∫"
            type="button"
            tabindex="0"
          >
            √ó
          </button>
        }
      </div>

      <button
        tuiButton
        (click)="openCreatePostDialog()"
        class="create-post-btn create-post-btn--highlighted"
        aria-label="–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø–æ—Å—Ç"
        type="button"
      >
        –°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç
      </button>
    </div>

    <!-- –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º -->
    @if (categories().length > 0) {
      <div class="categories-filter-section">
        <div class="categories-header">
          <h3 style="margin: 0;">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏:</h3>
        </div>
        <div class="categories-list" role="group" aria-label="–ö–∞—Ç–µ–≥–æ—Ä–∏–∏">
          <button
            tuiBadge
            [appearance]="selectedCategory() === null ? 'primary' : 'secondary'"
            (click)="sortByCategory(null)"
            (keyup.enter)="sortByCategory(null)"
            class="category-filter-btn"
            type="button"
            tabindex="0"
          >
            –í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
          </button>
          @for (category of categories(); track category.id) {
            <button
              tuiBadge
              [appearance]="selectedCategory() === category.name ? 'primary' : 'secondary'"
              (click)="sortByCategory(category.name || '')"
              (keyup.enter)="sortByCategory(category.name || '')"
              class="category-filter-btn"
              type="button"
              tabindex="0"
            >
              {{ category.name }}
            </button>
          }
        </div>
      </div>
    }

    <!-- –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–≥–∞–º -->
    @if (allTags().length > 0) {
      <div class="tags-filter-section">
        <div class="tags-header">
          <div class="tags-title-container">
            <h3 style="margin: 0;">–¢–µ–≥–∏:</h3>
            @if (selectedTags().length > 0) {
              <div class="selected-tags-counter">
                <span class="counter-number">{{ selectedTags().length }}</span>
                <span class="counter-text">–≤—ã–±—Ä–∞–Ω–æ</span>
              </div>
            }
          </div>
        </div>

        <div class="tags-content">
          <!-- –ü–æ–∏—Å–∫ —Å–ª–µ–≤–∞ -->
          <div class="tags-search-container">
            <input
              type="search"
              [ngModel]="tagSearchQuery()"
              (ngModelChange)="tagSearchQuery.set($event); applyTagSearch()"
              placeholder="–ü–æ–∏—Å–∫ —Ç–µ–≥–æ–≤..."
              class="tags-search-input"
              aria-label="–ü–æ–∏—Å–∫ —Ç–µ–≥–æ–≤"
            />
            @if (tagSearchQuery()) {
              <button
                class="clear-tag-search"
                (click)="clearTagSearch()"
                (keyup.enter)="clearTagSearch()"
                aria-label="–û—á–∏—Å—Ç–∏—Ç—å –ø–æ–∏—Å–∫ —Ç–µ–≥–æ–≤"
                type="button"
                tabindex="0"
              >
                √ó
              </button>
            }
            @if (tagSearchQuery()) {
              <div class="search-info">
                {{ filteredTags().length }} —Ç–µ–≥{{ filteredTags().length === 1 ? '' : '–∞' }}
              </div>
            }
          </div>

          <!-- –û–±–ª–∞–∫–æ —Ç–µ–≥–æ–≤ –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ -->
          <div class="tags-cloud-wrapper">
            <div class="tags-cloud-header">
              <span class="tags-count">
                {{ filteredTags().length }} —Ç–µ–≥{{ filteredTags().length === 1 ? '' : '–æ–≤' }}
              </span>
            </div>

            <div
              class="tags-cloud"
              role="group"
              aria-labelledby="tags-title"
              [class.expanded]="isTagsExpanded()"
            >
              @for (tag of filteredTags(); track tag.id) {
                <button
                  tuiBadge
                  [appearance]="getTagAppearance(tag.name || '')"
                  (click)="toggleTagFilter(tag.name || '')"
                  (keyup.enter)="toggleTagFilter(tag.name || '')"
                  class="tag-filter-btn"
                  [class.selected]="isTagSelected(tag.name || '')"
                  [attr.aria-pressed]="isTagSelected(tag.name || '')"
                  [attr.aria-checked]="isTagSelected(tag.name || '')"
                  type="button"
                  role="checkbox"
                  tabindex="0"
                >
                  <span class="tag-text">{{ tag.name }}</span>
                  @if (isTagSelected(tag.name || '')) {
                    <span class="tag-check">‚úì</span>
                  }
                </button>
              }
            </div>
          </div>

          <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–ø—Ä–∞–≤–∞ -->
          <div class="tags-controls">
            <button
              class="toggle-tags-btn"
              (click)="toggleTagsExpanded()"
              (keyup.enter)="toggleTagsExpanded()"
              [attr.aria-expanded]="isTagsExpanded()"
              aria-label="{{ isTagsExpanded() ? '–°–≤–µ—Ä–Ω—É—Ç—å —Ç–µ–≥–∏' : '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å —Ç–µ–≥–∏' }}"
              type="button"
              tabindex="0"
            >
              @if (isTagsExpanded()) {
                <span class="toggle-icon">‚ñ≤</span>
                <span class="toggle-text">–°–≤–µ—Ä–Ω—É—Ç—å</span>
              } @else {
                <span class="toggle-icon">‚ñº</span>
                <span class="toggle-text">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ</span>
              }
            </button>

            @if (selectedTags().length > 0) {
              <button
                class="clear-all-tags"
                (click)="selectedTags.set([]); applyFilters()"
                (keyup.enter)="selectedTags.set([]); applyFilters()"
                aria-label="–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ–≥–∏"
                type="button"
                tabindex="0"
              >
                –û—á–∏—Å—Ç–∏—Ç—å
              </button>
            }
          </div>
        </div>

        <!-- –í—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–µ–≥–∏ (–æ—Ç–¥–µ–ª—å–Ω—ã–π –±–ª–æ–∫) -->
        @if (selectedTags().length > 0) {
          <div class="selected-tags-preview">
            <div class="preview-label">–í—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–µ–≥–∏:</div>
            <div class="preview-tags">
              @for (tag of selectedTags(); track tag) {
                <div class="preview-tag">
                  {{ tag }}
                  <button
                    class="remove-preview-tag"
                    (click)="toggleTagFilter(tag)"
                    (keyup.enter)="toggleTagFilter(tag)"
                    aria-label="–£–¥–∞–ª–∏—Ç—å —Ç–µ–≥ {{ tag }}"
                    type="button"
                    tabindex="0"
                  >
                    √ó
                  </button>
                </div>
              }
            </div>
          </div>
        }
      </div>
    }

    <!-- –°–ø–∏—Å–æ–∫ –ø–æ—Å—Ç–æ–≤ -->
    <div class="posts-section">
      <div class="section-header">
        <h2 class="section-subtitle">–ü–æ—Å—Ç—ã —Å–æ–æ–±—â–µ—Å—Ç–≤–∞</h2>
        <div class="posts-count" aria-live="polite" aria-atomic="true">
          <span class="count-text">
            –ü–æ–∫–∞–∑–∞–Ω–æ {{ filteredPosts.length }} –∏–∑ {{ posts().length }}
          </span>
          @if (selectedCategory()) {
            <span class="category-filter-info">
              <span class="filter-icon">üìÇ</span>
              {{ selectedCategory() }}
            </span>
          }
          @if (selectedTags().length > 0) {
            <span class="tags-filter-info">
              <span class="filter-icon">üè∑Ô∏è</span>
              {{ selectedTags().length }} —Ç–µ–≥{{ selectedTags().length > 1 ? '–∞' : '' }}
            </span>
          }
        </div>
      </div>

      @if (isLoading()) {
        <div class="loading-state" aria-live="polite" aria-busy="true">
          <tui-loader aria-label="–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤"></tui-loader>
          <p>–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤...</p>
        </div>
      } @else if (posts().length === 0) {
        <div class="empty-state" role="alert">
          <h3>–ü–æ—Å—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3>
          <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏</p>
          <button
            tuiButton
            (click)="clearFilters()"
            (keyup.enter)="clearFilters()"
            type="button"
            aria-label="–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã"
            tabindex="0"
          >
            –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
          </button>
        </div>
      } @else {
        <!-- –°–ø–∏—Å–æ–∫ –ø–æ—Å—Ç–æ–≤ -->
        <div class="posts-list" role="list" aria-label="–°–ø–∏—Å–æ–∫ –ø–æ—Å—Ç–æ–≤">
          @for (post of filteredPosts; track post.id; let i = $index) {
            <div
              class="post-card-wrapper"
              role="listitem"
              [attr.aria-posinset]="i + 1"
              [attr.aria-setsize]="filteredPosts.length"
            >
              <a
                [routerLink]="['/post', post.id]"
                class="post-link"
                [attr.aria-label]="'–ü–æ—Å—Ç: ' + (post.title || '')"
              >
                <div class="post-card" [class.draft]="!post.isPublished">
                  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ—Å—Ç–∞ -->
                  <div class="post-header">
                    <div class="post-meta">
                      <div class="author-info">
                        <tui-avatar aria-hidden="true">
                          {{ post.authorId?.substring(0, 2) || 'AU' }}
                        </tui-avatar>
                        <div class="author-details">
                          <span class="author-id">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {{ post.authorId?.substring(0, 8) }}</span>
                          <span class="post-date">
                            {{ formatDate(post.createdAt) }}
                          </span>
                        </div>
                      </div>
                    </div>

                    @if (post.category) {
                      <div
                        class="category-badge"
                        aria-label="–ö–∞—Ç–µ–≥–æ—Ä–∏—è: {{ post.category }}"
                      >
                        {{ post.category }}
                      </div>
                    }
                  </div>

                  <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –ø–æ—Å—Ç–∞ -->
                  <div class="post-body">
                    <h3 class="post-title">
                      {{ post.title }}
                      @if (!post.isPublished) {
                        <tui-badge
                          class="draft-badge"
                          aria-label="–ß–µ—Ä–Ω–æ–≤–∏–∫"
                        >
                          –ß–µ—Ä–Ω–æ–≤–∏–∫
                        </tui-badge>
                      }
                    </h3>

                    <p class="post-excerpt">
                      {{ getPostExcerpt(post.content || '') }}
                    </p>

                    @if (post.tagNames && post.tagNames.length > 0) {
                      <div class="post-tags" role="group" aria-label="–¢–µ–≥–∏ –ø–æ—Å—Ç–∞">
                        @for (tag of post.tagNames; track tag) {
                          <span
                            class="post-tag"
                            [class.highlighted]="isTagSelected(tag)"
                            (click)="$event.preventDefault(); toggleTagFilter(tag)"
                            (keyup.enter)="toggleTagFilter(tag)"
                            tabindex="0"
                            role="button"
                          >
                            {{ tag }}
                            @if (isTagSelected(tag)) {
                              <span class="post-tag-check">‚úì</span>
                            }
                          </span>
                        }
                      </div>
                    }
                  </div>

                  <!-- –§—É—Ç–µ—Ä –ø–æ—Å—Ç–∞ -->
                  <div class="post-footer">
                    <div class="post-stats">
                      <span
                        class="stat"
                        tabindex="0"
                      >
                        0 –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
                      </span>
                      <span
                        class="stat"
                        tabindex="0"
                      >
                        <span class="stat-icon">üí¨</span>
                        0 –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
                      </span>
                    </div>
                  </div>
                </div>
              </a>
            </div>
          }
        </div>

        <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
        @if (totalPages > 1) {
          <div class="pagination-wrapper" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º">
            <tui-pagination
              [length]="totalPages"
              [(index)]="currentPageValue"
              class="pagination"
              aria-label="–ü–∞–≥–∏–Ω–∞—Ü–∏—è"
            ></tui-pagination>
          </div>
        }
      }
    </div>
  </div>

  <!-- –î–∏–∞–ª–æ–≥ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–∞ -->
  <app-create-post-dialog
    [open]="isCreatePostDialogOpen()"
    (closed)="closeCreatePostDialog()"
    (postCreated)="onPostCreated($event)"
  ></app-create-post-dialog>
</div>
